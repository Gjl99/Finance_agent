# é‡‘èåˆ†ææ™ºèƒ½ä½“ç³»ç»Ÿ - è°ƒè¯•æŒ‡å—

## å·²ä¿®å¤çš„é—®é¢˜

### 1. è‚¡ç¥¨ä»£ç è¯†åˆ«é—®é¢˜ âœ…
- **é—®é¢˜**: `920091åˆ†æä¸€ä¸‹è¿™æ”¯è‚¡ç¥¨` æ— æ³•è¯†åˆ«è‚¡ç¥¨ä»£ç 
- **åŸå› **: æ­£åˆ™è¡¨è¾¾å¼ä½¿ç”¨äº†å•è¯è¾¹ç•Œ `\b`ï¼Œå¯¼è‡´ç´§è·Ÿä¸­æ–‡çš„æ•°å­—æ— æ³•åŒ¹é…
- **ä¿®å¤**: ç§»é™¤å•è¯è¾¹ç•Œé™åˆ¶ï¼Œæ”¯æŒæ›´çµæ´»çš„åŒ¹é…
- **æ”¯æŒçš„ä»£ç **:
  - 6å¼€å¤´ â†’ ä¸Šæµ·äº¤æ˜“æ‰€ (sh.)
  - 0/3å¼€å¤´ â†’ æ·±åœ³äº¤æ˜“æ‰€ (sz.)
  - 9å¼€å¤´ â†’ æ·±åœ³äº¤æ˜“æ‰€åˆ›ä¸šæ¿æ³¨å†Œåˆ¶ (sz.)
  - 8/4å¼€å¤´ â†’ åŒ—äº¬äº¤æ˜“æ‰€ (bj.)

### 2. å·¥å…·è°ƒç”¨éªŒè¯é”™è¯¯ âœ…
- **é—®é¢˜**: `tool_calls.0.args` PydanticéªŒè¯é”™è¯¯ 
- **åŸå› **: APIè¿”å›å­—ç¬¦ä¸²æ ¼å¼çš„argsï¼Œä½†LangChainè¦æ±‚å­—å…¸
- **ä¿®å¤**: åœ¨ `chat_openai_wrapper.py` ä¸­è‡ªåŠ¨å°†å­—ç¬¦ä¸²è§£æä¸ºå­—å…¸

## è°ƒè¯•åŠŸèƒ½ä½¿ç”¨

### 1. å¯ç”¨è°ƒè¯•æ¨¡å¼

```bash
# æ–¹æ³•1: å‘½ä»¤è¡Œå‚æ•°
python -m src.main --command "åˆ†æ920091" --debug --debug-level verbose

# æ–¹æ³•2: ç¯å¢ƒå˜é‡
export FINANCIAL_AGENT_DEBUG=1
python -m src.main --command "åˆ†æ920091"
```

### 2. è°ƒè¯•çº§åˆ«

- `basic` - åŸºæœ¬ä¿¡æ¯ï¼ˆæ™ºèƒ½ä½“å¼€å§‹/ç»“æŸï¼‰
- `detailed` - è¯¦ç»†ä¿¡æ¯ï¼ˆåŒ…å«è¾“å…¥/è¾“å‡ºï¼‰
- `verbose` - å†—é•¿æ¨¡å¼ï¼ˆæ‰€æœ‰ç»†èŠ‚+æ€§èƒ½ç»Ÿè®¡ï¼‰

### 3. è°ƒè¯•é€‰é¡¹

```bash
--debug-no-color    # ç¦ç”¨å½©è‰²è¾“å‡º
--debug-no-save     # ä¸ä¿å­˜ä¸­é—´çŠ¶æ€
--debug-no-perf     # ä¸è·Ÿè¸ªæ€§èƒ½
```

### 4. ä½¿ç”¨è°ƒè¯•è¿è¡Œè„šæœ¬

```bash
# å®Œæ•´åˆ†æè°ƒè¯•
python debug_run.py --query "920091åˆ†æä¸€ä¸‹" --level verbose

# å•ä¸ªæ™ºèƒ½ä½“è°ƒè¯•
python debug_run.py --agent fundamental --stock sz.920091 --level detailed
```

## VS Code è°ƒè¯•é…ç½®

é¡¹ç›®å·²é…ç½® `.vscode/launch.json`ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼š

1. **Debug Financial Agent - èŒ…å°**: é¢„è®¾èŒ…å°(600519)åˆ†æ
2. **Debug Financial Agent - è‡ªå®šä¹‰æŸ¥è¯¢**: è¾“å…¥è‡ªå®šä¹‰æŸ¥è¯¢
3. **Debug Financial Agent - äº¤äº’æ¨¡å¼**: äº¤äº’å¼è¾“å…¥
4. **Debug Test Agent - åŸºæœ¬é¢/æŠ€æœ¯é¢/ä¼°å€¼/æ–°é—»**: å•ç‹¬è°ƒè¯•å„æ™ºèƒ½ä½“

### ä½¿ç”¨æ–¹æ³•:
1. æŒ‰ `F5` æˆ–ç‚¹å‡» "Run and Debug"
2. é€‰æ‹©é…ç½®
3. è®¾ç½®æ–­ç‚¹ï¼ˆå¯é€‰ï¼‰
4. å¼€å§‹è°ƒè¯•

## æµ‹è¯•ä¿®å¤

```bash
# æµ‹è¯•è‚¡ç¥¨ä»£ç è¯†åˆ«
echo "920091åˆ†æä¸€ä¸‹è¿™æ”¯è‚¡ç¥¨" | python -m src.main

# æµ‹è¯•å·¥å…·è°ƒç”¨ä¿®å¤
conda run -n agent python -c "
import sys
sys.path.insert(0, '.')
from src.utils.chat_openai_wrapper import _patched_convert_dict_to_message
test = {'tool_calls': [{'args': '{\"code\": \"sz.920091\"}'}]}
result = _patched_convert_dict_to_message(test)
print('æµ‹è¯•é€šè¿‡!' if isinstance(result.tool_calls[0]['args'], dict) else 'æµ‹è¯•å¤±è´¥!')
"
```

## è°ƒè¯•è¾“å‡ºç¤ºä¾‹

å¯ç”¨verboseæ¨¡å¼åï¼Œä½ å°†çœ‹åˆ°ï¼š

```
[22:48:19] ================================================================================
[22:48:19]   ğŸ¤– å¯åŠ¨æ™ºèƒ½ä½“: Fundamental Analyst
[22:48:19] ================================================================================

[22:48:19] ğŸ“¥ è¾“å…¥çŠ¶æ€ (Fundamental Analyst):
[22:48:19]   æŸ¥è¯¢: 920091åˆ†æä¸€ä¸‹è¿™æ”¯è‚¡ç¥¨
[22:48:19]   è‚¡ç¥¨ä»£ç : sz.920091
[22:48:19]   å…¬å¸åç§°: N/A

[22:48:19] âš™ï¸  æ‰§è¡Œ Fundamental Analyst...

[22:48:25] ğŸ“¤ è¾“å‡ºçŠ¶æ€ (Fundamental Analyst):
[22:48:25]   æ–°å¢æ•°æ®å­—æ®µ: fundamental_analysis
[22:48:25]   
[22:48:25]   fundamental_analysis å†…å®¹é¢„è§ˆ:
[22:48:25]     ### åŸºæœ¬é¢åˆ†ææŠ¥å‘Š
                
                #### å…¬å¸åŸºæœ¬ä¿¡æ¯
                - è‚¡ç¥¨ä»£ç ï¼šsz.920091
                - å…¬å¸åç§°ï¼š...

[22:48:25] âœ… Fundamental Analyst å®Œæˆ - è€—æ—¶: 6.24ç§’
[22:48:25] --------------------------------------------------------------------------------
```

## ä¸­é—´çŠ¶æ€æ–‡ä»¶

å¯ç”¨è°ƒè¯•æ¨¡å¼åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä¿å­˜ï¼š

- **è°ƒè¯•æ—¥å¿—**: `debug_logs/debug_YYYYMMDD_HHMMSS.log`
- **ä¸­é—´çŠ¶æ€**: `debug_states/YYYYMMDD_HHMMSS_<agent_name>_state.json`
- **æ‰§è¡Œæ—¥å¿—**: `logs/YYYYMMDD_HHMMSS_<id>/`

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆæˆ‘çš„ä¿®æ”¹æ²¡æœ‰ç”Ÿæ•ˆï¼Ÿ
A: æ¸…é™¤Pythonç¼“å­˜:
```bash
find . -name "*.pyc" -delete
find . -type d -name "__pycache__" -exec rm -rf {} +
```

### Q: å¦‚ä½•æŸ¥çœ‹è¯¦ç»†çš„å·¥å…·è°ƒç”¨æ—¥å¿—ï¼Ÿ
A: è®¾ç½®ç¯å¢ƒå˜é‡:
```bash
export LANGCHAIN_VERBOSE=1
export LANGCHAIN_TRACING_V2=true
```

### Q: 920091è¿˜æ˜¯æ— æ³•è¯†åˆ«ï¼Ÿ
A: ç¡®è®¤ä»£ç å·²æ›´æ–°ï¼š
```bash
grep "pattern18 = r'(\\d{5,6})'" src/main.py
# åº”è¯¥çœ‹åˆ°ä¸å¸¦\bçš„æ¨¡å¼
```

## æ€§èƒ½åˆ†æ

è°ƒè¯•æ¨¡å¼ä¼šè‡ªåŠ¨è®°å½•æ¯ä¸ªæ™ºèƒ½ä½“çš„æ‰§è¡Œæ—¶é—´ï¼š

```
ğŸ“Š æ€§èƒ½ç»Ÿè®¡æ‘˜è¦

æ€»æ‰§è¡Œæ—¶é—´: 125.34ç§’

Fundamental Analyst  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  45.23s ( 36.1%)
News Analyst         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  32.18s ( 25.7%)
Technical Analyst    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  24.51s ( 19.5%)
Value Analyst        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  18.92s ( 15.1%)
Summary Agent        â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   4.50s (  3.6%)
```
